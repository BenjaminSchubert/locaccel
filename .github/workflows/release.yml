name: release

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  test:
    uses: ./.github/workflows/test.yml
    permissions:
      contents: read
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  oci_image:
    name: oci
    uses: ./.github/workflows/oci.yml
    needs:
      - test
    with:
      publish: true
      tags: |
        type=semver,pattern={{version}}
        type=semver,pattern={{major}}.{{minor}}
        type=semver,pattern={{major}}
    permissions:
      id-token: write
      contents: read
      attestations: write
      packages: write

  package:
    uses: ./.github/workflows/package.yml
    permissions:
      contents: read

  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs:
      - package
      - oci_image
      - test

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          ref: ${{ github.ref_name }}

      - name: Extract git tag information
        run: |
          echo "GIT_TAG_BODY<<EOF" | tee --append $GITHUB_ENV
          echo "$(git tag -l --format='%(contents:body)' ${{ github.ref_name }})" | tee --append $GITHUB_ENV
          echo "EOF" | tee --append $GITHUB_ENV

      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          name: locaccel-packages
          path: dist/

      - name: Create release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b  # v2.5.0
        with:
          body: ${{ env.GIT_TAG_BODY }}
          files: dist/*.tar.gz
          fail_on_unmatched_files: true
          generate_release_notes: true
